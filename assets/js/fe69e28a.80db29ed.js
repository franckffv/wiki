"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[102],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>m});var a=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var l=a.createContext({}),p=function(e){var t=a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(r),k=n,m=d["".concat(l,".").concat(k)]||d[k]||u[k]||o;return r?a.createElement(m,i(i({ref:t},c),{},{components:r})):a.createElement(m,i({ref:t},c))}));function m(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,i=new Array(o);i[0]=k;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:n,i[1]=s;for(var p=2;p<o;p++)i[p]=r[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,r)}k.displayName="MDXCreateElement"},115:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=r(7462),n=(r(7294),r(3905));const o={sidebar_position:2},i="Step 2: Setting up docker swarm with traefik and portainer",s={unversionedId:"tutorial-basics/step-2",id:"tutorial-basics/step-2",title:"Step 2: Setting up docker swarm with traefik and portainer",description:"Intro",source:"@site/docs/tutorial-basics/step-2.md",sourceDirName:"tutorial-basics",slug:"/tutorial-basics/step-2",permalink:"/wiki/docs/tutorial-basics/step-2",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tutorial-basics/step-2.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Step 1: SetUp server",permalink:"/wiki/docs/tutorial-basics/step-1"},next:{title:"Step 3: Deploy new app with docker-compose",permalink:"/wiki/docs/tutorial-basics/step-3"}},l={},p=[{value:"Intro",id:"intro",level:2},{value:"What is traefik?",id:"what-is-traefik",level:3},{value:"What is Docker Swarm?",id:"what-is-docker-swarm",level:3},{value:"Init Docker Swarm",id:"init-docker-swarm",level:3},{value:"Create a traefik network",id:"create-a-traefik-network",level:3},{value:"Create a htpasswd password",id:"create-a-htpasswd-password",level:3},{value:"Create folders for Traefik",id:"create-folders-for-traefik",level:3},{value:"Traefik docker compose",id:"traefik-docker-compose",level:3},{value:"Portainer",id:"portainer",level:3}],c={toc:p},d="wrapper";function u(e){let{components:t,...r}=e;return(0,n.kt)(d,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"step-2-setting-up-docker-swarm-with-traefik-and-portainer"},"Step 2: Setting up docker swarm with traefik and portainer"),(0,n.kt)("h2",{id:"intro"},"Intro"),(0,n.kt)("p",null,"In this post we will see how to create a docker swarm and deploy traefik and portainer in a debian server."),(0,n.kt)("h3",{id:"what-is-traefik"},"What is traefik?"),(0,n.kt)("p",null,"Traefik is a leading modern reverse proxy and load balancer that makes deploying microservices easy. Traefik integrates with your existing infrastructure components and configures itself automatically and dynamically."),(0,n.kt)("p",null,"For more info visit : ",(0,n.kt)("a",{parentName:"p",href:"https://traefik.io/traefik"},"https://traefik.io/traefik"),"\nWhat is portainer?"),(0,n.kt)("p",null,"Portainer is the definitive container management tool for Docker, Docker Swarm with it's highly intuitive GUI and API. Portainer is a fully featured management tool for Docker. It runs locally, giving developers a rich UI to build and publish container images, deploy and manage applications and leverage data persistence and horizontal scaling for their applications. And, once an application is deployed into a container, Portainer makes it easy for users to secure, monitor and measure the performance of the platform. The tool negates the need for developers to learn Infrastructure as Code and makes it easy for them to maximize their efficiency which means both users and organizations love it."),(0,n.kt)("p",null,"For more info visit: ",(0,n.kt)("a",{parentName:"p",href:"https://www.portainer.io/"},"https://www.portainer.io/")),(0,n.kt)("h3",{id:"what-is-docker-swarm"},"What is Docker Swarm?"),(0,n.kt)("p",null,"Docker swarm is a container orchestration tool, meaning that it allows the user to manage multiple containers deployed across multiple host machines. One of the key benefits associated with the operation of a docker swarm is the high level of availability offered for applications."),(0,n.kt)("p",null,"For more info: ",(0,n.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/swarm/"},"https://docs.docker.com/engine/swarm/")),(0,n.kt)("h3",{id:"init-docker-swarm"},"Init Docker Swarm"),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"}," Know your ip ")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"ip addr\n")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"sudo docker swarm init --advertise-addr 10.0.0.3 # change the ip here with your machine ip\n")),(0,n.kt)("p",null,"This will initialize docker in swarm mode and also display a join token for the other machines to join the cluster."),(0,n.kt)("h3",{id:"create-a-traefik-network"},"Create a traefik network"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"docker network create --driver overlay traefik-public \n")),(0,n.kt)("p",null,"This is our primary network for the traefik."),(0,n.kt)("h3",{id:"create-a-htpasswd-password"},"Create a htpasswd password"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},'sudo docker run --rm httpd:2.4-alpine htpasswd -nbB admin <password> | cut -d ":" -f 2\n')),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"}," Escape the $ sign in the password by adding one more $ to the generated password. We need this password to protect our end point in the traefik proxy. ")),(0,n.kt)("p",null,"Keep this password safe we will need it later."),(0,n.kt)("h3",{id:"create-folders-for-traefik"},"Create folders for Traefik"),(0,n.kt)("p",null,"create a folder and set 600 as permission."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /mnt/data\nmkdir /mnt/data/traefik\ntouch /mnt/data/traefik/acme.json\nchmod 600 /mnt/data/traefik/acme.json\nmkdir /mnt/compose \n")),(0,n.kt)("h3",{id:"traefik-docker-compose"},"Traefik docker compose"),(0,n.kt)("p",null,"Traefik is our main reverse proxy and it will sit in front of all out application. we will control all the routes to our containers using traefik."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"cd /mnt/compose\ntouch traefik.yml\nnano traefik.yml\n")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3.3"\n\nservices:\n  traefik:\n    image: "traefik:latest"\n    command:\n      - --log.level=INFO\n      - --entrypoints.web.address=:80\n      - --entrypoints.websecure.address=:443\n      - --providers.docker\n      - --providers.docker.exposedbydefault=false\n      - --providers.docker.swarmmode=true\n      - --providers.docker.network=traefik-public\n      - --api\n      - --api.dashboard=true\n      - --certificatesresolvers.leresolver.acme.caserver=https://acme-v02.api.letsencrypt.org/directory\n      # update your email here\n      - --certificatesresolvers.leresolver.acme.email=valentino.folio@yourdomain.com\n      # Make sure the this file is available and permission is set correctly\n      - --certificatesresolvers.leresolver.acme.storage=/le/acme.json\n      - --certificatesresolvers.leresolver.acme.tlschallenge=true\n    ports:\n      - "80:80"\n      - "443:443"\n    networks:\n      - traefik-public\n    volumes:\n      - "/var/run/docker.sock:/var/run/docker.sock:ro"\n      # Make sure the volume folder is created\n      - "/mnt/data/traefik/acme.json:/le/acme.json"\n    deploy:\n      labels:\n        # Dashboard\n        - "traefik.enable=true"\n        # Change the host url here\n        - "traefik.http.routers.traefik.rule=Host(`traefik.yourdomain.com`)"\n        - "traefik.http.routers.traefik.service=api@internal"\n        - "traefik.http.services.traefik.loadbalancer.server.port=8080"\n        - "traefik.http.routers.traefik.tls.certresolver=leresolver"\n        - "traefik.http.routers.traefik.entrypoints=websecure"\n        - "traefik.http.routers.traefik.middlewares=authtraefik"\n        # Change the auth password here\n        - "traefik.http.middlewares.authtraefik.basicauth.users=admin:$$2y$$05$$bgRr0cehUg8CL8us4u80UuIsy.kDi9DjVNdCuXhVEHF626kIE5Glu" # user/password\n\n        # global redirect to https\n        - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)"\n        - "traefik.http.routers.http-catchall.entrypoints=web"\n        - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"\n\n        # middleware redirect\n        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"\n\n  my-app:\n    image: containous/whoami:latest\n    networks:\n      - traefik-public\n    command:\n      - --port=8082 # Our service listens on 8082\n    deploy:\n      labels:\n        - "traefik.enable=true"\n        # Change the host url here\n        - "traefik.http.routers.my-app.rule=Host(`whoami.test.yourdomain.com`)"\n        - "traefik.http.services.my-app.loadbalancer.server.port=8082"\n        - "traefik.http.routers.my-app.middlewares=auth"\n        - "traefik.http.routers.my-app.entrypoints=websecure"\n        - "traefik.http.routers.my-app.tls=true"\n        - "traefik.http.routers.my-app.tls.certresolver=leresolver"\n        # Change the password here\n        - "traefik.http.middlewares.auth.basicauth.users=admin:$$2y$$05$$bgRr0cehUg8CL8us4u80UuIsy.kDi9DjVNdCuXhVEHF626kIE5Glu" # user/password\n\nnetworks:\n  traefik-public:\n    external: true\n\n')),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Deploy the stack")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"}," docker stack deploy -c traefik.yml traefik\n")),(0,n.kt)("h3",{id:"portainer"},"Portainer"),(0,n.kt)("p",null,"Portainer is our container management software. We will use to deploy our docker containers."),(0,n.kt)("p",null,"Create folder for Portainer"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /mnt/data/portainer\n")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"cd /mnt/compose\ntouch portainer.yml\nnano portainer.yml\n")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yml"},'version: "3.2"\n\nservices:\n  agent:\n    image: portainer/agent\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n      - /var/lib/docker/volumes:/var/lib/docker/volumes\n    networks:\n      - traefik-public\n    deploy:\n      mode: global\n      placement:\n        constraints: [node.platform.os == linux]\n\n  portainer:\n    image: portainer/portainer\n    command: -H tcp://tasks.agent:9001 --tlsskipverify\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n      # make sure the folder is available (mkdir /mnt/data/portainer)\n      - /mnt/data/portainer:/data\n    networks:\n      - traefik-public\n    deploy:\n      labels:\n        - "traefik.enable=true"\n        # change the host here\n        - "traefik.http.routers.portainer.rule=Host(`admin.test.yourdomain.com`)"\n        - "traefik.http.services.portainer.loadbalancer.server.port=9000"\n        - "traefik.http.routers.portainer.entrypoints=websecure"\n        - "traefik.http.routers.portainer.tls=true"\n        - "traefik.http.routers.portainer.tls.certresolver=leresolver"\n      mode: replicated\n      placement:\n        constraints: [node.role == manager]\n\nnetworks:\n  traefik-public:\n    external: true\n')),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Deploy the stack")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"}," docker stack deploy -c portainer.yml portainer\n")))}u.isMDXComponent=!0}}]);